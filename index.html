<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>واتساب مصغّر مع Firebase</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Basic Reset */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Cairo', sans-serif;
            direction: rtl; /* Right-to-left for Arabic */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.5s ease;
            background: linear-gradient(135deg, #1a1a2e, #16213e); /* CSS Feature 6: Gradient Background */
            color: var(--text-color); /* Use CSS variables */
            --bg-color: #1a1a2e; /* Dark Mode Default */
            --text-color: #e0e0e0;
            --primary-color: #4a4e69;
            --secondary-color: #9191a1;
            --my-message-bg: #4a4e69;
            --other-message-bg: #2e3a4e;
            --input-bg: #2e3a4e;
            --input-text: #e0e0e0;
            --border-color: #4a4e69;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --scroll-button-bg: #5e6b8c;
            --header-bg: #16213e;
            --login-error-color: #ff6b6b; /* Define error color as variable */
            --user-list-bg-color: #2e3a4e; /* Slightly different background for user list */
            --select-bg: #2e3a4e; /* Background for dropdown */
            --select-text: #e0e0e0; /* Text color for dropdown */
            --select-border: var(--border-color);
        }

        /* CSS Feature 1: Dark Mode (Default) */
        /* -- variables defined in body */

        #login-container {
            background-color: var(--bg-color);
            padding: 30px;
            border-radius: 15px; /* CSS Feature 13: Rounded Corners */
            box-shadow: 0 10px 25px var(--shadow-color); /* CSS Feature 12: Soft Shadow */
            text-align: center;
        }

        #login-container h2 {
            margin-bottom: 20px;
            color: var(--text-color);
        }

        #login-container input {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px; /* CSS Feature 13: Rounded Corners */
            background-color: var(--input-bg);
            color: var(--input-text);
            font-size: 1rem;
        }

        #login-container button {
            width: 100%;
            padding: 12px;
            background-color: #5e6b8c;
            color: white;
            border: none;
            border-radius: 8px; /* CSS Feature 13: Rounded Corners */
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }

        #login-container button:hover {
            background-color: #7a8ba5;
        }

        #login-container button:active {
            transform: scale(0.98); /* CSS Feature 14: Button Animation */
        }

        #login-error {
            color: var(--login-error-color); /* Use variable */
            margin-top: 15px;
            font-size: 0.9rem;
        }

         #firebase-chat-init-error { /* Style for Firebase init error */
             color: var(--login-error-color);
             margin-top: 10px;
             font-size: 0.9rem;
         }


        #chat-container {
            display: none; /* Hidden by default */
            width: 95%;
            max-width: 800px;
            height: 95vh;
            max-height: 900px;
            background-color: var(--bg-color);
            border-radius: 15px; /* CSS Feature 13: Rounded Corners */
            box-shadow: 0 10px 30px var(--shadow-color); /* CSS Feature 12: Soft Shadow */
            overflow: hidden;
            display: grid;
            grid-template-rows: auto 1fr auto; /* Header, Messages, Input */
            grid-template-columns: 1fr 200px; /* Main chat area, User list (default wide screen) */
            grid-template-areas:
                "header header"
                "messages userlist"
                "input input";
            position: relative; /* For scroll button positioning */
            transition: grid-template-columns 0.3s ease; /* Smooth transition for layout changes */
        }

        /* Responsive Layout */
        @media (max-width: 768px) {
            #chat-container {
                 grid-template-columns: 1fr; /* Stack columns by default on small screens */
                 grid-template-areas:
                    "header"
                    "messages"
                    "input";
            }

             #chat-container.user-list-visible {
                 grid-template-columns: 1fr; 
                 grid-template-areas:
                     "header"
                     "messages"
                     "input"; 
                 overflow: hidden; 
             }
        }


        #chat-header {
            grid-area: header;
            background-color: var(--header-bg);
            color: var(--text-color);
            padding: 10px 15px; 
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            flex-wrap: wrap; 
            gap: 10px; 
        }

         #chat-header .header-title { 
             flex-grow: 1; 
             text-align: center; 
         }

          #chat-header .header-title span {
               display: block; 
               font-size: 0.9em;
               font-weight: normal;
               color: var(--secondary-color);
          }

        #group-select { 
            padding: 8px;
            border: 1px solid var(--select-border);
            border-radius: 5px;
            background-color: var(--select-bg);
            color: var(--select-text);
            font-size: 1rem;
            cursor: pointer;
            outline: none;
             flex-shrink: 0; 
        }


        #user-list-toggle-button { 
             background-color: transparent;
             color: var(--text-color);
             border: none;
             padding: 5px;
             cursor: pointer;
             margin-left: 10px; 
             display: none; 
              flex-shrink: 0; 
         }

        @media (max-width: 768px) {
            #user-list-toggle-button {
                 display: block; 
                 order: -1; 
            }
        }

         #user-list-toggle-button svg {
             width: 24px;
             height: 24px;
             fill: currentColor;
         }


        #user-list {
            grid-area: userlist; 
            width: 200px; 
            background-color: var(--user-list-bg-color); 
            padding: 15px;
            overflow-y: auto;
            border-left: 1px solid var(--border-color);
             transition: transform 0.3s ease; 

            @media (max-width: 768px) {
                 position: fixed; 
                 top: 0; 
                 right: -200px; 
                 bottom: 0; 
                 width: 200px; 
                 z-index: 50; 
                 box-shadow: -5px 0 15px var(--shadow-color); 
                 border-left: none; 
                 transform: translateX(0); 
            }
        }

         @media (max-width: 768px) {
             #chat-container.user-list-visible #user-list {
                 transform: translateX(-200px); 
             }
         }


        #user-list h4 {
            color: var(--secondary-color);
            margin-bottom: 10px;
        }

        #user-list ul {
            list-style: none;
            padding: 0;
        }

        #user-list li {
            color: var(--text-color);
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.3s ease; 
        }

         #user-list li:hover {
             background-color: rgba(255, 255, 255, 0.1);
         }

        .online-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #4caf50; /* Green */
            margin-right: 5px;
            vertical-align: middle;
        }

         .offline-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #f44336; /* Red */
            margin-right: 5px;
            vertical-align: middle;
        }

        .last-seen {
            font-size: 0.8em;
            color: var(--secondary-color);
            display: block; 
        }


        #message-area {
            grid-area: messages;
            padding: 20px;
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }

        .message {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            max-width: 80%;
            opacity: 0; 
            transform: translateY(20px); 
            animation: fadeInSlideUp 0.5s forwards ease; 
        }

         @keyframes fadeInSlideUp {
             to {
                 opacity: 1;
                 transform: translateY(0);
             }
         }

        .my-message {
            align-self: flex-end; 
            flex-direction: row-reverse; 
        }

         .other-message {
             align-self: flex-start; 
             flex-direction: row; 
         }

        .message-avatar {
             width: 40px;
             height: 40px;
             border-radius: 50%; 
             background-color: var(--secondary-color); 
             display: flex;
             justify-content: center;
             align-items: center;
             color: white;
             font-weight: bold;
             flex-shrink: 0; 
             overflow: hidden; 
         }

        .message-avatar img {
             width: 100%;
             height: 100%;
             object-fit: cover;
             display: block;
         }


        .message-content {
            background-color: var(--other-message-bg);
            padding: 12px 18px;
            border-radius: 20px; 
            color: var(--text-color);
            word-break: break-word; 
            box-shadow: 0 2px 5px var(--shadow-color); 
            transition: background-color 0.3s ease; 
            position: relative; 
        }

         .my-message .message-content {
             background-color: var(--my-message-bg); 
         }

         .message-content:hover {
             background-color: rgba(255, 255, 255, 0.15); 
         }


        .message-sender {
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--secondary-color);
        }

        .message-text {
            font-size: 1rem;
            line-height: 1.5;
        }

        .message-image {
            max-width: 250px; 
            max-height: 250px;
            border-radius: 10px; 
            cursor: pointer;
            display: block; 
            transition: opacity 0.5s ease; 
            object-fit: cover; 
        }

         .message-image.loading {
             opacity: 0.5; 
         }

        .delete-button {
            position: absolute;
            top: -8px; 
            left: -8px; 
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7em;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            opacity: 0; 
            transition: opacity 0.2s ease;
        }

         .my-message .delete-button {
            left: auto; 
            right: -8px; 
         }

         .message-content:hover .delete-button {
             opacity: 1; 
         }


        #input-area {
            grid-area: input;
            display: flex;
            padding: 15px;
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-color);
            gap: 10px; 
        }

        #message-input {
            flex-grow: 1; 
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 25px; 
            background-color: var(--input-bg);
            color: var(--input-text);
            font-size: 1rem;
            outline: none; 
        }

        #image-upload-button,
        #send-button {
            background-color: #5e6b8c;
            color: white;
            border: none;
            border-radius: 50%; 
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            flex-shrink: 0; 
        }

         #image-upload-button:hover,
         #send-button:hover {
             background-color: #7a8ba5;
         }

         #image-upload-button:active,
         #send-button:active {
             transform: scale(0.9); 
         }


         #image-upload-button svg,
         #send-button svg {
             width: 24px;
             height: 24px;
             fill: currentColor; 
         }


        #scroll-to-bottom {
            position: absolute;
            bottom: 80px; 
            right: 20px; 
            background-color: var(--scroll-button-bg);
            color: white;
            border: none;
            border-radius: 50%; 
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 2px 5px var(--shadow-color);
            transition: background-color 0.3s ease, opacity 0.3s ease;
            opacity: 0; 
            visibility: hidden;
            z-index: 10; 
        }

         #scroll-to-bottom.show {
             opacity: 1;
             visibility: visible;
         }

         #scroll-to-bottom svg {
             width: 24px;
             height: 24px;
             fill: currentColor;
         }


        #image-modal {
            display: none; 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); 
            backdrop-filter: blur(5px); 
            z-index: 100; 
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
             position: relative; 
             max-width: 90%;
             max-height: 90%;
             display: flex;
             justify-content: center;
             align-items: center;
             overflow: hidden; 
         }

        #modal-image {
            display: block;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; 
            cursor: grab; 
        }

         #modal-image.dragging {
             cursor: grabbing;
         }


        .modal-close,
        .modal-download {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 110; 
            transition: background-color 0.3s ease;
        }

        .modal-close {
            top: 15px;
            right: 15px; 
        }
         .modal-download {
             top: 15px;
             left: 15px; 
         }

        .modal-close:hover,
        .modal-download:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body>

    <div id="login-container">
        <h1>Mahmoud المبرمج</h1>
        <h2>تسجيل الدخول</h2>
        <input type="text" id="login-code" placeholder="الكود">
        <input type="text" id="login-name" placeholder="الاسم">
        <button id="login-button">دخول</button>
        <p id="login-error"></p>
         <p id="firebase-chat-init-error" style="color: var(--login-error-color); margin-top: 10px;"></p>
    </div>

    <div id="chat-container">
        <div id="chat-header">
             <button id="user-list-toggle-button" title="تبديل قائمة المستخدمين">
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 6h16a1 1 0 0 0 0-2H4a1 1 0 0 0 0 2zm16 7H4a1 1 0 0 0 0 2h16a1 1 0 0 0 0-2zm0 7H4a1 1 0 0 0 0 2h16a1 1 0 0 0 0-2z" fill="currentColor"/></svg>
             </button>
             <select id="group-select"></select> <div class="header-title">
                 <span id="group-name"></span> <span id="current-username"></span> </div>
             </div>
         <div id="user-list">
             <h4>الأعضاء</h4>
             <ul>
                 </ul>
         </div>
        <div id="message-area">
            </div>
        <div id="input-area">
            <input type="text" id="message-input" placeholder="اكتب رسالة...">
            <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
            <button id="image-upload-button" title="إرسال صورة">
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 4h3l2-2h6l2 2h3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2zm4.5 8a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7zM19 6a1 1 0 1 0 0-2 1 1 0 0 0 0 2z" fill="currentColor"/></svg>
            </button>
            <button id="send-button" title="إرسال">
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" fill="currentColor"/></svg>
            </button>
        </div>

        <button id="scroll-to-bottom" title="انزل للأسفل">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 16.414l-4.707-4.707a1 1 0 0 0-1.414 1.414l5.414 5.414a1 1 0 0 0 1.414 0l5.414-5.414a1 1 0 0 0-1.414-1.414L12 16.414z" fill="currentColor"/></svg>
        </button>
    </div>

     <div id="image-modal">
         <div class="modal-content">
             <img id="modal-image" src="img1.jpg" alt="صورة مكبّرة">
             <button class="modal-close">&times;</button>
             <button class="modal-download" title="تحميل الصورة">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zm-7 11a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1v-3h-4v3z" fill="currentColor"/></svg>
             </button>
         </div>
     </div>


    <script src="https://www.gstatic.com/firebasejs/11.7.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.7.3/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.7.3/firebase-storage-compat.js"></script>
     <script src="https://www.gstatic.com/firebasejs/11.7.3/firebase-analytics-compat.js"></script>


    <script>
        console.log("Chat script loaded.");

        const firebaseConfig = {
          apiKey: "AIzaSyDgBBp8TATR616ssonog_W00mLoMzC5X6I", 
          authDomain: "login-page-ce50f.firebaseapp.com",
          projectId: "login-page-ce50f",
          storageBucket: "login-page-ce50f.firebasestorage.app",
          messagingSenderId: "274104600411",
          appId: "1:274104600411:web:0a0248a995bea745e33c7e",
          measurementId: "G-E1PKLWQHYB" 
        };
        console.log("Firebase config:", firebaseConfig);

        let app = null;
        let database = null;
        let storage = null;
        let analytics = null;

        let allowedUsersRef = null;
        let onlineUsersRef = null;
        let storageRef = null;
        let groupsRef = null; 

        const loginContainer = document.getElementById('login-container');
        const loginCodeInput = document.getElementById('login-code');
        const loginNameInput = document.getElementById('login-name');
        const loginButton = document.getElementById('login-button');
        const loginError = document.getElementById('login-error');
        const firebaseChatInitErrorElement = document.getElementById('firebase-chat-init-error');

        const chatContainer = document.getElementById('chat-container');
        const chatHeader = document.getElementById('chat-header');
        const userListToggleButton = document.getElementById('user-list-toggle-button');
        const groupSelect = document.getElementById('group-select'); 
        const headerTitleSpan = document.querySelector('#chat-header .header-title');
        const groupNameSpan = document.getElementById('group-name');
        const currentUsernameSpan = document.getElementById('current-username');

        const userList = document.getElementById('user-list');
        const userListUl = document.querySelector('#user-list ul');
        const messageArea = document.getElementById('message-area');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const imageUploadButton = document.getElementById('image-upload-button');
        const imageUploadInput = document.getElementById('image-upload-input');
        const scrollToBottomButton = document.getElementById('scroll-to-bottom');

        const imageModal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        const modalCloseButton = document.querySelector('.modal-close');
        const modalDownloadButton = document.querySelector('.modal-download');

        let currentUser = null; 
        let currentUserId = null; 
        let currentGroupId = null; 
        let currentGroupName = null; 
        let messagesListener = null; 

        let isScrolling = false;
        let isPinching = false;
        let initialDistance = 0;
        let initialX = 0; 
        let initialY = 0; 
        let currentScale = 1; 

        function generatePersistentUserId(code, name) {
             return `${code}_${name.toLowerCase().replace(/\s+/g, '').replace(/[.#$\[\]]/g, '_')}`;
         }

        function scrollToBottom() {
             if(messageArea) {
                messageArea.scrollTop = messageArea.scrollHeight;
                messageArea.classList.remove('scrolling');
             }
        }

        function toggleScrollButton() {
             if(messageArea && scrollToBottomButton) {
                if (messageArea.scrollHeight - messageArea.scrollTop > messageArea.clientHeight + 100) {
                    scrollToBottomButton.classList.add('show');
                } else {
                    scrollToBottomButton.classList.remove('show');
                }
             }
        }

        function playNotificationSound() {
             try {
                 const audio = new Audio('data:audio/wav;base64,UklGRlIAAABXQVZFZm10RBIADAAAAAEAAQIAQB8AAEAfAAABAAEAaW5mbwAAAEkAAADgfEJUUkxUBAAAAgAAAFJpcpYdHA==')
                 audio.play().catch(e => console.warn("Error playing sound:", e.message));
             } catch (e) {
                 console.warn("Browser does not support Audio API or playback failed:", e.message);
             }
         }

        function showLogin() {
            if(loginContainer) loginContainer.style.display = 'block';
            if(chatContainer) chatContainer.style.display = 'none';
             if (window.innerWidth <= 768 && chatContainer) {
                 chatContainer.classList.remove('user-list-visible');
                 if(userList) userList.style.display = 'none';
             }
        }

        function showChat() {
            if(loginContainer) loginContainer.style.display = 'none';
            if(chatContainer) chatContainer.style.display = 'grid';

             if(messageArea) {
                 messageArea.addEventListener('scroll', toggleScrollButton);
                 toggleScrollButton();
             }

             if (window.innerWidth <= 768 && userList) {
                 userList.style.display = 'none';
             }

             if(window.innerWidth <= 768 && userListToggleButton) {
                 userListToggleButton.style.display = 'block';
             } else if (userListToggleButton) {
                 userListToggleButton.style.display = 'none';
             }
        }


        function displayMessage(message) {
            if (!messageArea) return;

            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.dataset.messageId = message.key;

            const isMyMessage = currentUser && message.senderId === currentUser.userId;

            if (isMyMessage) {
                messageElement.classList.add('my-message');
            } else {
                messageElement.classList.add('other-message');
            }

            const avatarElement = document.createElement('div');
            avatarElement.classList.add('message-avatar');
            avatarElement.textContent = message.senderName ? message.senderName.substring(0, 2).toUpperCase() : '??';


            const contentElement = document.createElement('div');
            contentElement.classList.add('message-content');

            const senderElement = document.createElement('div');
            senderElement.classList.add('message-sender');
            senderElement.textContent = message.senderName || 'مستخدم غير معروف';

            contentElement.appendChild(senderElement);


            if (message.type === 'text') {
                const textElement = document.createElement('div');
                textElement.classList.add('message-text');
                textElement.textContent = message.text;
                contentElement.appendChild(textElement);
            } else if (message.type === 'image' && message.imageUrl) {
                const imgElement = document.createElement('img');
                imgElement.classList.add('message-image');
                imgElement.src = message.imageUrl;
                 imgElement.classList.add('loading');
                imgElement.onload = () => {
                     imgElement.classList.remove('loading');
                     if (messageArea.scrollHeight - messageArea.scrollTop - messageArea.clientHeight < 50) {
                         scrollToBottom();
                     }
                 };
                 imgElement.onerror = () => {
                     console.error("Failed to load image:", message.imageUrl);
                     const errorText = document.createElement('div');
                     errorText.classList.add('message-text');
                     errorText.style.color = 'red';
                     errorText.textContent = 'فشل تحميل الصورة';
                     contentElement.appendChild(errorText);
                 };
                imgElement.dataset.imageUrl = message.imageUrl;
                contentElement.appendChild(imgElement);
            }

             if (isMyMessage && database && currentGroupId && message.key) { 
                 const messageRef = database.ref('groupMessages').child(currentGroupId).child(message.key);

                 const deleteButtonElement = document.createElement('button');
                 deleteButtonElement.classList.add('delete-button');
                 deleteButtonElement.textContent = 'x';
                 deleteButtonElement.title = 'حذف الرسالة';
                 deleteButtonElement.addEventListener('click', () => {
                    console.log("Attempting to delete message with key:", message.key, "from group:", currentGroupId);
                     messageRef.remove() 
                         .then(() => console.log("Message removed successfully:", message.key))
                         .catch(error => console.error("Error removing message:", error));
                 });
                 contentElement.appendChild(deleteButtonElement);
             }


            if (isMyMessage) {
                 messageElement.appendChild(contentElement);
                 messageElement.appendChild(avatarElement);
            } else {
                 messageElement.appendChild(avatarElement);
                 messageElement.appendChild(contentElement);
            }


            messageArea.appendChild(messageElement);

            if (isMyMessage || (messageArea.scrollHeight - messageArea.scrollTop - messageArea.clientHeight) < 200) {
                 messageArea.classList.add('scrolling');
                 setTimeout(scrollToBottom, 100);
             }

             if (!isMyMessage && document.visibilityState === 'visible') { // Only play sound if tab is active
                 playNotificationSound();
             }
        }

        function updateOnlineUsersList(users) {
            if (!userListUl) return;
            userListUl.innerHTML = '';
            if (users) {
                const sortedUserIds = Object.keys(users).sort((uidA, uidB) => {
                    const userA = users[uidA];
                    const userB = users[uidB];

                    if (!userA || !userB) return 0;

                    if (userA.isOnline && !userB.isOnline) return -1;
                    if (!userA.isOnline && userB.isOnline) return 1;

                    const nameA = userA.name || '';
                    const nameB = userB.name || '';
                    return nameA.localeCompare(nameB, 'ar');
                });


                sortedUserIds.forEach(userId => {
                     const user = users[userId];
                     if (!user || !user.name) {
                          console.warn("Skipping invalid user entry in online list:", user);
                          return;
                     }

                    const li = document.createElement('li');

                    const statusSpan = document.createElement('span');
                    statusSpan.classList.add(user.isOnline ? 'online-status' : 'offline-status');
                    statusSpan.title = user.isOnline ? 'متصل' : 'غير متصل';

                    li.appendChild(statusSpan);
                    li.appendChild(document.createTextNode(user.name));


                    if (!user.isOnline && user.lastSeen) {
                        const lastSeenSpan = document.createElement('span');
                        lastSeenSpan.classList.add('last-seen');
                         const lastSeenTime = new Date(user.lastSeen);
                         try {
                              lastSeenSpan.textContent = ` (آخر ظهور: ${lastSeenTime.toLocaleDateString('ar-EG')} ${lastSeenTime.toLocaleTimeString('ar-EG')})`;
                         } catch (e) {
                              console.error("Error formatting last seen date:", user.lastSeen, e);
                              lastSeenSpan.textContent = ` (آخر ظهور: غير معروف)`;
                         }
                        li.appendChild(lastSeenSpan);
                    }

                    userListUl.appendChild(li);
                });
            }
        }

         function updateChatHeaderTitle(groupName, userName) {
             if(groupNameSpan) {
                  groupNameSpan.textContent = groupName || 'المجموعة غير محددة'; 
             }
             if(currentUsernameSpan) {
                  currentUsernameSpan.textContent = userName ? `أنت: ${userName}` : ''; 
             }
         }

         function populateGroupSelect(groups) {
             if (!groupSelect) return;
             const previouslySelectedGroupId = groupSelect.value; // Preserve selection if possible
             groupSelect.innerHTML = '';

             const defaultOption = document.createElement('option');
             defaultOption.value = ''; 
             defaultOption.textContent = 'اختر مجموعة...';
             defaultOption.disabled = true; 
             // defaultOption.selected = true; // Don't select by default if we try to preserve selection
             groupSelect.appendChild(defaultOption);


             let restoredSelection = false;
             if (groups) {
                 Object.keys(groups).forEach(groupId => {
                     const group = groups[groupId];
                     if (group && group.name) {
                         const option = document.createElement('option');
                         option.value = groupId;
                         option.textContent = group.name;
                         if (groupId === previouslySelectedGroupId) {
                             option.selected = true;
                             restoredSelection = true;
                         }
                         groupSelect.appendChild(option);
                     }
                 });
             }
             if (!restoredSelection) {
                defaultOption.selected = true; // Select default if previous was not found or no previous
             }
         }


         function selectGroup(groupId, groupName) {
             console.log(`Attempting to select group: ${groupId} (${groupName})`);

             if (!database) {
                  console.error("Firebase Database not initialized.");
                  return;
             }

             if (messagesListener && currentGroupId && currentGroupId !== groupId) { 
                  console.log(`Detaching message listener for old group: ${currentGroupId}`);
                 database.ref('groupMessages').child(currentGroupId).off('child_added', messagesListener);
                 messagesListener = null; 
             } else if (currentGroupId === groupId && messagesListener) {
                 console.log("Group already selected and listener active:", groupId);
                 // Update header just in case name changed, though groupRef listener should handle group name changes.
                 if(currentUser) updateChatHeaderTitle(groupName, currentUser.name); else updateChatHeaderTitle(groupName, '');
                 return; // Avoid re-attaching if already on this group
             }


             if(messageArea) messageArea.innerHTML = '';
             console.log("Cleared message area for new group.");


             currentGroupId = groupId;
             currentGroupName = groupName;
             console.log(`Current group state updated: ${currentGroupId} (${currentGroupName})`);

             if(currentUser) { 
                  updateChatHeaderTitle(currentGroupName, currentUser.name);
             } else {
                  updateChatHeaderTitle(currentGroupName, ''); 
             }

             if (currentGroupId) {
                  console.log(`Attaching message listener for group: ${currentGroupId}`);
                 const groupMessagesRef = database.ref('groupMessages').child(currentGroupId);

                 messagesListener = groupMessagesRef.orderByChild('timestamp').on('child_added', snapshot => { // Order by timestamp
                     const message = snapshot.val();
                     message.key = snapshot.key;
                      console.log("New message received (group listener):", message);
                     displayMessage(message); 
                 }, error => {
                     console.error(`Error listening to messages for group ${currentGroupId}:`, error);
                 });
                
                 // No need for separate .once('value') as .on('child_added') will fetch existing then new ones.
                 // Ensure scroll after messages might have loaded
                 setTimeout(scrollToBottom, 500); // Increased delay slightly for ordered messages

                  if(messageInput) messageInput.disabled = false;
                  if(sendButton) sendButton.disabled = false;
                  if(imageUploadButton) imageUploadButton.disabled = false;


             } else {
                  console.log("No group selected, message listener not attached.");
                  if(messageInput) messageInput.disabled = true;
                  if(sendButton) sendButton.disabled = true;
                  if(imageUploadButton) imageUploadButton.disabled = true;
             }
         }


        // --- Firebase Initialization and Setup ---
        try {
            app = firebase.initializeApp(firebaseConfig);
            database = app.database();
            storage = app.storage();
            analytics = firebase.analytics(); 

            allowedUsersRef = database.ref('allowedUsers');
            onlineUsersRef = database.ref('onlineUsers');
            groupsRef = database.ref('groups'); 
            storageRef = storage.ref('chat_images');


            console.log("Firebase chat initialized successfully. References ready.");
            
              if(groupsRef && groupSelect) {
                   groupsRef.on('value', snapshot => {
                       const groupsData = snapshot.val();
                       console.log("Groups list received/updated:", groupsData);
                       populateGroupSelect(groupsData);

                       // If a group is currently selected, check if its name changed
                       if (currentGroupId && groupsData && groupsData[currentGroupId] && groupsData[currentGroupId].name !== currentGroupName) {
                           currentGroupName = groupsData[currentGroupId].name;
                           if (currentUser) {
                               updateChatHeaderTitle(currentGroupName, currentUser.name);
                           } else {
                               updateChatHeaderTitle(currentGroupName, '');
                           }
                       }
                       // If no group is selected AND user is logged in, try to select the first available one.
                       // This is also handled after login, but good for scenarios where groups load after login.
                       else if (!currentGroupId && currentUser && groupsData && Object.keys(groupsData).length > 0) {
                           const firstGroupId = Object.keys(groupsData)[0];
                           if (firstGroupId && groupSelect.querySelector(`option[value="${firstGroupId}"]`)) {
                                groupSelect.value = firstGroupId;
                                selectGroup(firstGroupId, groupsData[firstGroupId].name || firstGroupId);
                           }
                       } else if ((!groupsData || Object.keys(groupsData).length === 0) && currentUser) {
                            console.warn("No groups available in Firebase.");
                            updateChatHeaderTitle("لا توجد مجموعات", currentUser.name);
                            if(messageInput) messageInput.disabled = true;
                            if(sendButton) sendButton.disabled = true;
                            if(imageUploadButton) imageUploadButton.disabled = true;
                       }
                   }, error => {
                       console.error("Error listening to groups list:", error);
                       updateChatHeaderTitle("خطأ في المجموعات", currentUser ? currentUser.name : '');
                        if(messageInput) messageInput.disabled = true;
                        if(sendButton) sendButton.disabled = true;
                        if(imageUploadButton) imageUploadButton.disabled = true;
                   });
                   console.log("Groups list listener attached.");
              } else {
                  console.error("Groups select element or Firebase refs not found. Group feature disabled.");
                   updateChatHeaderTitle("خطأ في تهيئة المجموعات", currentUser ? currentUser.name : '');
                    if(messageInput) messageInput.disabled = true;
                    if(sendButton) sendButton.disabled = true;
                    if(imageUploadButton) imageUploadButton.disabled = true;
              }


             if(onlineUsersRef && userListUl) {
                 onlineUsersRef.on('value', snapshot => {
                     const onlineUsersData = snapshot.val(); 
                      console.log("Online users data received (global listener):", onlineUsersData);
                     updateOnlineUsersList(onlineUsersData);
                 }, error => {
                     console.error("Error listening to online users:", error);
                 });
                  console.log("Online users listener attached.");

                  // No need for manual lastSeenInterval if onDisconnect and login handle it.
                  // const lastSeenInterval = setInterval(() => { ... });
             } else {
                 console.error("Online users list element or Firebase refs not found. Online user list disabled.");
             }
        } catch (error) {
            console.error("Firebase chat initialization failed:", error);
            if(firebaseChatInitErrorElement) {
                firebaseChatInitErrorElement.textContent = 'فشل تهيئة Firebase للدردشة. يرجى التحقق من إعداداتك واتصالك بالإنترنت. الخطأ: ' + error.message;
            } else {
                if(loginError) loginError.textContent = 'فشل تهيئة Firebase. يرجى التحقق من إعداداتك واتصالك بالإنترنت.';
                else alert('فشل تهيئة Firebase. يرجى التحقق من إعداداتك واتصالك بالإنترنت.');
            }

             if(loginButton) loginButton.disabled = true;
             if(loginCodeInput) loginCodeInput.disabled = true;
             if(loginNameInput) loginNameInput.disabled = true; 
             if(messageInput) messageInput.disabled = true;
             if(sendButton) sendButton.disabled = true;
             if(imageUploadButton) imageUploadButton.disabled = true;
             if(groupSelect) groupSelect.disabled = true; 
        }


        // --- Event Handlers ---

        if (loginButton && loginCodeInput && loginNameInput && database) { 
            loginButton.addEventListener('click', () => {
                const code = loginCodeInput.value.trim();
                const name = loginNameInput.value.trim();
                if(loginError) loginError.textContent = ''; 

                if (!code || !name) {
                    if(loginError) loginError.textContent = 'الرجاء إدخال الكود والاسم.';
                    return;
                }

                console.log(`Login attempt with code: ${code}, name: ${name}`);

                if (!allowedUsersRef || !onlineUsersRef) { 
                    if(loginError) loginError.textContent = 'نظام التحقق أو الحضور غير جاهز. حاول مرة أخرى.';
                    console.error("Firebase refs (allowedUsersRef or onlineUsersRef) not initialized.");
                    return;
                }

                allowedUsersRef.child(code).once('value', snapshot => {
                    if (snapshot.exists()) {
                        console.log("Login code is valid.");
                        currentUserId = generatePersistentUserId(code, name);
                        currentUser = { code: code, name: name, userId: currentUserId };

                        const userStatusRef = onlineUsersRef.child(currentUserId);
                        const userDataOnline = {
                            name: currentUser.name,
                            isOnline: true,
                            lastSeen: firebase.database.ServerValue.TIMESTAMP // This will be updated on connect
                        };
                        const userDataOffline = {
                            name: currentUser.name, // Keep name on disconnect
                            isOnline: false,
                            lastSeen: firebase.database.ServerValue.TIMESTAMP
                        };

                        // 1. Set up onDisconnect behavior
                        userStatusRef.onDisconnect().set(userDataOffline)
                            .then(() => {
                                console.log("onDisconnect handler set for user:", currentUserId);
                                // 2. Set current status to online
                                return userStatusRef.set(userDataOnline);
                            })
                            .then(() => {
                                console.log("User set as online. Showing chat.");
                                showChat();
                                updateChatHeaderTitle(currentGroupName, currentUser.name); 

                                if (!currentGroupId && groupSelect && groupSelect.options.length > 0) {
                                    let firstSelectableOption = null;
                                    for(let i=0; i < groupSelect.options.length; i++) {
                                        if (!groupSelect.options[i].disabled && groupSelect.options[i].value) {
                                            firstSelectableOption = groupSelect.options[i];
                                            break;
                                        }
                                    }

                                    if (firstSelectableOption) {
                                        groupSelect.value = firstSelectableOption.value; 
                                        console.log(`Auto-selecting group: ${firstSelectableOption.value} - ${firstSelectableOption.text}`);
                                        selectGroup(firstSelectableOption.value, firstSelectableOption.text);
                                    } else {
                                         console.warn("No selectable group found to auto-select.");
                                         if(messageInput) messageInput.disabled = true;
                                         if(sendButton) sendButton.disabled = true;
                                         if(imageUploadButton) imageUploadButton.disabled = true;
                                    }
                                } else if (currentGroupId && currentGroupName) {
                                    selectGroup(currentGroupId, currentGroupName);
                                }
                            })
                            .catch(error => {
                                console.error("Error setting user online or onDisconnect:", error);
                                if(loginError) loginError.textContent = 'خطأ في تسجيل حالة الاتصال. حاول مرة أخرى.';
                                currentUser = null; currentUserId = null;
                            });

                    } else {
                        console.log("Login code is invalid.");
                        if(loginError) loginError.textContent = 'الكود المدخل غير صحيح.';
                    }
                }, error => {
                    console.error("Error accessing allowed users:", error);
                    if(loginError) loginError.textContent = 'خطأ في التحقق من الكود. حاول مرة أخرى.';
                });
            });
            console.log("Login button event listener attached.");
        } else {
            console.error("Could not attach login button event listener. Crucial elements or Firebase database ref missing.");
            if(loginContainer && loginContainer.style.display !== 'none' && loginError) { 
                 loginError.textContent = "خطأ في تهيئة زر الدخول. حاول تحديث الصفحة.";
            }
        }


         if(groupSelect) {
             groupSelect.addEventListener('change', (event) => {
                 const selectedGroupId = event.target.value;
                 const selectedOption = event.target.options[event.target.selectedIndex];
                 const selectedGroupName = selectedOption ? selectedOption.text : null;
                 if (selectedGroupId && selectedGroupName && selectedOption && !selectedOption.disabled) { 
                      selectGroup(selectedGroupId, selectedGroupName);
                 } else if (!selectedGroupId) { 
                      console.warn("Default 'select group' option chosen. No action taken.");
                      if(messageInput) messageInput.disabled = true;
                      if(sendButton) sendButton.disabled = true;
                      if(imageUploadButton) imageUploadButton.disabled = true;
                 }
             });
              console.log("Group select change listener attached.");
         }


         if(sendButton && messageInput && database) { 
             sendButton.addEventListener('click', () => {
                  console.log("Send button clicked!");
                 const text = messageInput.value.trim();
                 if (text && currentUser && currentUser.userId && currentGroupId) {
                     const groupMessagesRef = database.ref('groupMessages').child(currentGroupId);
                     const newMessage = {
                         type: 'text',
                         senderName: currentUser.name,
                         senderId: currentUser.userId,
                         text: text,
                         timestamp: firebase.database.ServerValue.TIMESTAMP
                     };
                      console.log("Sending text message:", newMessage, "to group:", currentGroupId);
                     groupMessagesRef.push(newMessage) 
                         .then(() => {
                             console.log("Text message sent successfully.");
                             messageInput.value = '';
                         })
                         .catch(error => {
                             console.error("Error sending text message:", error);
                         });
                 } else {
                      console.warn("Send click ignored: Text empty, user not logged in, or no group selected.");
                 }
             });
              console.log("Event listener attached to send button.");
         }


         if(messageInput && sendButton) {
             messageInput.addEventListener('keypress', (event) => {
                  console.log("Key pressed in message input:", event.key);
                 if (event.key === 'Enter') {
                     event.preventDefault();
                     sendButton.click();
                 }
             });
              console.log("Event listener attached to message input (keypress).");
         }


         if(imageUploadButton && imageUploadInput) {
             imageUploadButton.addEventListener('click', () => {
                  console.log("Image upload button clicked.");
                 imageUploadInput.click();
             });
              console.log("Event listener attached to image upload button.");
         }


         if(imageUploadInput && storage && database) { 
              imageUploadInput.addEventListener('change', (event) => {
                   console.log("Image upload input change event fired.");
                  const file = event.target.files[0];
                  if (file && currentUser && currentUser.userId && currentGroupId && storageRef) { 
                       console.log("File selected:", file.name);
                      const fileName = `${Date.now()}_${file.name}`;
                      const imageFileRef = storageRef.child(`${currentUser.userId}/${fileName}`); 

                      console.log("Starting image upload to:", imageFileRef.fullPath);
                      const uploadTask = imageFileRef.put(file);

                      uploadTask.on('state_changed',
                          (snapshot) => {
                              const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                              console.log('Upload is ' + progress.toFixed(2) + '% done');
                          },
                          (error) => {
                              console.error("Image upload failed:", error);
                          },
                          () => {
                              console.log("Image upload complete. Getting download URL...");
                              uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                                  console.log('File available at', downloadURL);

                                   const groupMessagesRef = database.ref('groupMessages').child(currentGroupId);
                                  const newMessage = {
                                      type: 'image',
                                      senderName: currentUser.name,
                                      senderId: currentUser.userId, 
                                      imageUrl: downloadURL,
                                      timestamp: firebase.database.ServerValue.TIMESTAMP
                                  };
                                  console.log("Sending image message:", newMessage, "to group:", currentGroupId);
                                  groupMessagesRef.push(newMessage) 
                                      .then(() => {
                                          console.log("Image message sent successfully.");
                                      })
                                      .catch(error => {
                                          console.error("Error sending image message:", error);
                                      });
                              });
                          }
                      );
                  } else {
                       console.warn("Image upload ignored: No file, user not logged in, no group selected, or storageRef not ready.");
                  }
                  event.target.value = null;
              });
              console.log("Event listener attached to image upload input.");
         }


         if(scrollToBottomButton) {
             scrollToBottomButton.addEventListener('click', () => {
                  console.log("Scroll to bottom button clicked.");
                 scrollToBottom();
             });
              console.log("Event listener attached to scroll to bottom button.");
         }


         if(messageArea && imageModal && modalCloseButton && modalDownloadButton && modalImage) {
              messageArea.addEventListener('click', (event) => {
                   console.log("Message area clicked.", event.target);
                  if (event.target.classList.contains('message-image')) {
                      console.log("Clicked element is a message image.");
                      const imageUrl = event.target.dataset.imageUrl;
                      if (imageUrl) {
                          console.log("Showing image modal for URL:", imageUrl);
                          modalImage.src = imageUrl;
                          imageModal.style.display = 'flex';
                          modalDownloadButton.dataset.imageUrl = imageUrl;
                      }
                  }
              });
               console.log("Event listener attached to message area for image clicks.");

              modalCloseButton.addEventListener('click', () => {
                  console.log("Modal close button clicked.");
                  imageModal.style.display = 'none';
                  modalImage.src = '';
                   modalImage.style.transform = 'scale(1)';
                   modalImage.style.left = '0px'; 
                   modalImage.style.top = '0px';  
                   isPinching = false;
                   initialX = initialY = initialDistance = 0;
                   currentScale = 1;
              });
               console.log("Event listener attached to modal close button.");


              imageModal.addEventListener('click', (event) => {
                   console.log("Image modal background clicked.", event.target);
                  if (event.target === imageModal) {
                      console.log("Clicked on modal background, closing modal.");
                      modalCloseButton.click();
                  }
              });
               console.log("Event listener attached to modal background for closing.");


              modalDownloadButton.addEventListener('click', () => {
                  console.log("Modal download button clicked.");
                  const imageUrl = modalDownloadButton.dataset.imageUrl;
                  if (imageUrl) {
                      console.log("Attempting to download image from URL:", imageUrl);
                      const link = document.createElement('a');
                      link.href = imageUrl;
                      link.download = 'chat_image_' + new Date().getTime();
                      document.body.appendChild(link);
                      link.click();
                      document.body.removeChild(link);
                       console.log("Download link created and clicked.");
                  } else {
                       console.warn("Download button clicked but no image URL found.");
                  }
              });
               console.log("Event listener attached to modal download button.");

               console.log("Touch event listeners for image modal attached.");
               modalImage.addEventListener('touchstart', (event) => {
                   if (event.touches.length === 2) {
                       isPinching = true;
                       initialDistance = Math.hypot(event.touches[1].clientX - event.touches[0].clientX, event.touches[1].clientY - event.touches[0].clientY);
                       currentScale = parseFloat(modalImage.style.transform.replace('scale(', '').replace(')', '')) || 1;
                       event.preventDefault(); 
                   } else if (event.touches.length === 1 && currentScale > 1) { 
                        initialX = event.touches[0].clientX - (parseFloat(modalImage.style.left) || 0);
                        initialY = event.touches[0].clientY - (parseFloat(modalImage.style.top) || 0);
                        modalImage.classList.add('dragging');
                        event.preventDefault(); 
                   }
               }, { passive: false });


               modalImage.addEventListener('touchmove', (event) => {
                   if (isPinching && event.touches.length === 2) {
                       event.preventDefault();
                       const currentDistance = Math.hypot(event.touches[1].clientX - event.touches[0].clientX, event.touches[1].clientY - event.touches[0].clientY);
                       const scale = currentScale * (currentDistance / initialDistance);
                       modalImage.style.transform = `scale(${Math.min(Math.max(scale, 0.5), 4)})`;
                   } else if (event.touches.length === 1 && modalImage.classList.contains('dragging')) {
                       event.preventDefault();
                       const newX = event.touches[0].clientX - initialX;
                       const newY = event.touches[0].clientY - initialY;
                       modalImage.style.left = `${newX}px`;
                       modalImage.style.top = `${newY}px`;
                   }
               }, { passive: false });


               modalImage.addEventListener('touchend', (event) => { 
                    if (event.touches.length < 2) isPinching = false; 
                    if (event.touches.length < 1) modalImage.classList.remove('dragging'); 
               });


         } else {
              console.error("Critical image modal elements not found. Image preview/download will not work.");
         }

          if (userListToggleButton && chatContainer && userList) {
              userListToggleButton.addEventListener('click', () => {
                  console.log("User list toggle button clicked.");
                  const isVisible = chatContainer.classList.toggle('user-list-visible');
                  userList.style.display = isVisible ? 'block' : 'none';
              });
              console.log("Event listener attached to user list toggle button.");

               if (window.innerWidth <= 768) { 
                   document.addEventListener('click', (event) => {
                        if (window.innerWidth <= 768) { 
                            const isClickInsideUserList = userList && userList.contains(event.target);
                            const isClickOnToggleButton = userListToggleButton && userListToggleButton.contains(event.target);
                            const isListVisible = chatContainer && chatContainer.classList.contains('user-list-visible');

                            if (isListVisible && !isClickInsideUserList && !isClickOnToggleButton) {
                                console.log("Clicked outside user list/toggle button on mobile, closing.");
                                userListToggleButton.click(); 
                            }
                        }
                   });
                   console.log("Global click listener attached for closing user list on mobile.");
               }
          } else {
               console.error("User list toggle button or chat/user list containers not found.");
          }


    // --- Initial Setup ---

    if(loginContainer && chatContainer) {
        showLogin();
         console.log("Showing login screen.");
    } else {
         console.error("Login or chat containers not found. Cannot show initial screen.");
    }

     window.addEventListener('resize', () => {
          console.log("Window resized. Checking layout...");
          const isSmallScreen = window.innerWidth <= 768;
          if(userListToggleButton) userListToggleButton.style.display = isSmallScreen ? 'block' : 'none';

          if (isSmallScreen) {
              if (userList) {
                  if (!chatContainer || !chatContainer.classList.contains('user-list-visible')) {
                      userList.style.display = 'none';
                  } else {
                      userList.style.display = 'block'; 
                  }
              }
          } else { 
              if(userList) userList.style.display = 'block'; 
              if(chatContainer) chatContainer.classList.remove('user-list-visible');
          }
     });
      window.dispatchEvent(new Event('resize')); 
       console.log("Resize listener attached and triggered.");


     window.addEventListener('beforeunload', () => {
          console.log("Window beforeunload event triggered.");
          // No explicit action needed here if onDisconnect is correctly set up.
          // Firebase handles the disconnect and triggers the onDisconnect listener.
          // If currentUser and currentUserId are null (user never logged in or somehow logged out clean), 
          // then onDisconnect wouldn't have been set for this session.
          if (currentUser && currentUserId && onlineUsersRef && database.app.options) { // Check if firebase is still configured
              // Optional: For an even cleaner exit, you might consider removing the onDisconnect handler
              // if the user is explicitly logging out via a button (not just closing the tab).
              // onlineUsersRef.child(currentUserId).onDisconnect().cancel();
              // onlineUsersRef.child(currentUserId).update({ isOnline: false, lastSeen: firebase.database.ServerValue.TIMESTAMP });
              // However, for tab close, onDisconnect().set() is the most reliable.
          }
     });
      console.log("beforeunload listener attached.");


     console.log("Chat script fully executed.");
    </script>

</body>
</html>
